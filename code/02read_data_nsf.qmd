---
title: "Read clean and join NSF data"
format: html
editor: source
---

```{r}
# Packages
library(tidyverse)
library(here)
```

# Summary of script and output datafile structure

This script processes and joins NSF grant data from multiple sources to create an analysis dataset of NSF grants with termination information.

## Data Sources

- **NSF Award Search** (bulk download): All grants 2014-2026, downloaded as JSON files and converted to TSV
- **Grant Witness**: Termination/suspension status for affected grants

## Processing Steps

1. Read NSF grant data from TSV files (2014-2019 and 2020-2026)
2. Select and combine relevant columns
3. Read Grant Witness termination data
4. Join datasets on grant_id
5. Create analysis dataset with renamed columns
6. Save analysis dataset
7. Create email-level dataset (one row per PI email)

## Output Files

- `data_analysis/nsf_analysis.csv`: CSV format for broad compatibility
- `data_analysis/nsf_analysis.rds`: RDS format preserving R data types
- `data_analysis/nsf_emails.csv`: One row per PI email

## Dataset Statistics

| Metric         | Count   |
|----------------|---------|
| Total rows     | ~350,000 |
| Total columns  | 26      |
| Cut grants     | ~1,600   |
| Non-cut grants | ~348,000 |
| Years          | 2014-2026 |

## Column Structure (26 columns)

**From NSF (12 columns)** - authoritative grant data:

- IDs: grant_id, agcy_id
- PI: pi_names, pi_emails
- Project: title, abstract
- Dates: start_date, end_date
- Budget: total_budget, amount_awarded
- Organization: org_name, org_state

**From Grant Witness (13 columns)** - termination-specific:

- Status: terminated, suspended, termination_date
- Reinstatement: reinstated, reinstatement_date
- Agency info: award_type, division, directorate, nsf_program_name
- Spending: usasp_outlaid, estimated_remaining, post_termination_deobligation
- URLs: nsf_url, usaspending_url

**Derived (1 column):**

- was_cut: TRUE/FALSE flag indicating if grant was terminated

**Note:** Cut grants have `was_cut == TRUE`. Use `was_cut` or `!is.na(terminated)` to filter.

# CODE

## Load final analysis dataset

```{r load-analysis-dataset}
# Load the final analysis dataset (run the code below only if you need to regenerate it)
nsf_analysis <- readRDS(here('data_analysis/nsf_analysis.rds'))
cat("Loaded NSF analysis dataset:", nrow(nsf_analysis), "grants,", ncol(nsf_analysis), "columns\n")
glimpse(nsf_analysis)
``` 

# Read in and join NSF Data (Sources: NSF and Grant Witness)

```{r}
# NSF all grants 2020-2025, exported from website via json files: https://www.nsf.gov/awardsearch/download-awards
# Define a column specification: force awd_id to character
col_spec <- cols(
  awd_id = col_character(),
  .default = col_guess()  # everything else guessed automatically
)

# Read both files with the same column specification
nsf_2014_2019 <- read_tsv(here('data/NSF_all_grants_2019-2014.tsv'), col_types = col_spec)
nsf_2020_2026 <- read_tsv(here('data/NSF_all_grants_2026-2020.tsv'), col_types = col_spec)

# Combine
nsf_all <- bind_rows(nsf_2014_2019, nsf_2020_2026)

#remove from environment
nsf_2014_2019 = NULL
nsf_2020_2026 = NULL

# select required columns from nsf_all
nsf_all = nsf_all %>%
  select(c(awd_id, agcy_id, pi_names, awd_titl_txt, awd_eff_date, awd_exp_date, tot_intn_awd_amt, awd_amount, pi_emails, inst_name, inst_state, fund_oblg_amt, awd_abstract_narration))

# NSF cut grants from grantwitness.us
col_spec <- cols(
  grant_id = col_character(),
  award_type = col_factor(),
  directorate = col_factor(),
  .default = col_guess()
)
nsf_cut <- read_csv(here('data/grant_witness_nsf_terminations.csv'), col_types = col_spec)
glimpse(nsf_cut)
```

## Check if coosa data on cut grants is more or less comprehensive than Grant Witness data

```{r, check which grants got lost from nsf_cut}
# SOURCE: COOSA: https://cossa.org/nsf-releases-list-of-terminated-grants/
# to do: match award ID to NSF data_raw by grant witness, that is most likely more comprehensive (n=1667 rows)
nsf_cut2 = readr::read_csv(here('data/cossa_NSF-Terminated-Awards.csv'), col_types = 'cccccl') |> # delete columns without names and mostly NA cells (...6)
  select(-starts_with("..."))

# which grants in nsf_cut2 are not included in nsf_cut? None are not included. We can safely ignore data from the coosa website.  
nsf_cut2_missing <- nsf_cut2 %>%
  anti_join(nsf_cut, by = c("Award ID" = "grant_id"))
cat("Grants from COSSA not contained in Grant Witness NSF data:", nrow(nsf_cut2_missing), "\n")
```

## Which budget columns should we keep? 
 
### From the nsf_cut file (Grant Witness data):

NSF-sourced:
  - nsf_total_budget: Total budget from NSF
  - nsf_obligated: Amount NSF has committed (obligated)

  USAspending-sourced:
  - usasp_total_obligated: Total obligated per USAspending
  - usasp_total_obligated_corrected: Corrected version (possibly accounting for errors)
  - usasp_outlaid: Amount actually paid out (disbursed)

  Calculated/estimated: The estimated_ columns seem to be derived/calculated columns by Grant Witness, likely to reconcile discrepancies between NSF and USAspending data sources
  - estimated_budget: Likely derived from above sources
  - estimated_outlays: Estimated amount spent
  - estimated_remaining: Budget minus spent (the "lost" money)

  Termination-specific:
  - post_termination_deobligation: Money clawed back after termination

  ### From nsf_all (official NSF data):

  For the nsf_all data, tot_intn_awd_amt and awd_amount are the official NSF grant values which apply to ALL grants (not just terminated ones).

  - tot_intn_awd_amt → total_budget: The total intended award amount (full planned grant value)
  - awd_amount → amount_awarded: Actual awarded amount (may differ from intended if grant was modified)

  ### Which columns should we keep from each dataset?

  1. Use nsf_all for base budget info (total_budget, amount_awarded) - it's authoritative for all grants
  2. From nsf_cut, keep only what's unique to terminated grants:
    - usasp_outlaid - actual money spent (useful for analyzing impact)
    - estimated_remaining - money "lost" when grant was cut
    - post_termination_deobligation - money clawed back

We could simplify to keep estimated_budget, estimated_outlays, estimated_remaining instead - they're a coherent set. However:

  - usasp_outlaid is more authoritative (direct from USAspending) than estimated_outlays 

## Join NSF all and NSF cut data, remove redundant columns

```{r, join nsf_all and nsf_cut}
# Strategy: nsf_all is the authoritative source for grant metadata.
# From nsf_cut, only keep termination-specific columns (not duplicated in nsf_all).

# Rename grant ID in nsf_all for joining
nsf_all <- nsf_all %>%
  rename(grant_id = awd_id)

# From nsf_cut: keep only termination-specific columns + grant_id
nsf_cut_slim <- nsf_cut %>%
  select(
    grant_id,
    terminated, suspended, termination_date,
    reinstated, reinstatement_date,
    cruz_list, nsf_url, usaspending_url,
    award_type, division, directorate, nsf_program_name,
    # Spending info (only available for cut grants)
    usasp_outlaid,          # actual money spent before termination
    estimated_remaining,    # budget minus spent (money "lost")
    post_termination_deobligation  # money clawed back
  )

# Join: all grants from nsf_all, add termination info where available
nsf_joined <- nsf_all %>%
  left_join(nsf_cut_slim, by = "grant_id") %>%
  mutate(was_cut = !is.na(terminated) & terminated == TRUE)

glimpse(nsf_joined)
```

## Check join results

```{r, check join results}
# How many grants were cut?
cat("Cut grants in joined data:", sum(nsf_joined$was_cut), "\n")
cat("Total cut grants in source:", nrow(nsf_cut), "\n")

# Which grants got lost in the join (not in nsf_all)?
nsf_cut_lost <- nsf_cut %>%
  anti_join(nsf_all, by = "grant_id")
cat("Cut grants not found in nsf_all:", nrow(nsf_cut_lost), "\n")
```

## Create an analysis dataset: select and rename columns 

```{r, create analysis dataset}
# Select and rename columns for analysis
# Columns from nsf_all (authoritative source) + termination info from nsf_cut
nsf_analysis <- nsf_joined %>%
  select(
    grant_id,
    agcy_id,
    pi_names,
    pi_emails,
    title = awd_titl_txt,
    abstract = awd_abstract_narration,
    start_date = awd_eff_date,
    end_date = awd_exp_date,
    total_budget = tot_intn_awd_amt,
    amount_awarded = awd_amount,
    org_name = inst_name,
    org_state = inst_state,
    # Termination info from nsf_cut
    was_cut,
    terminated, suspended, termination_date,
    reinstated, reinstatement_date,
    nsf_url, usaspending_url,
    award_type, division, directorate, nsf_program_name,
    # Spending info for cut grants
    usasp_outlaid, estimated_remaining, post_termination_deobligation
  ) %>%
  arrange(desc(was_cut), grant_id)  # cut grants first

write_csv(nsf_analysis, here('data_analysis/nsf_analysis.csv'))
saveRDS(nsf_analysis, here('data_analysis/nsf_analysis.rds'))
cat("NSF analysis dataset:", nrow(nsf_analysis), "grants,", ncol(nsf_analysis), "columns\n")
cat("Saved to data_analysis/nsf_analysis.csv and .rds\n")
glimpse(nsf_analysis)
```

# Expand to one row per email (split pi_emails into separate rows)

```{r, create email-level dataset}

nsf_emails <- nsf_analysis %>%
  separate_rows(pi_emails, sep = ",\\s*") %>%
  filter(!is.na(pi_emails) & pi_emails != "") %>%
  filter(str_detect(pi_emails, "@")) %>%
  filter(!str_detect(pi_emails, "@SIDDUPLICATE\\.sid$"))

write_csv(nsf_emails, here('data_analysis/nsf_emails.csv'))

cat("Email dataset:", nrow(nsf_emails), "rows\n")
cat("Unique emails:", n_distinct(nsf_emails$pi_emails), "\n")
cat("Cut grant rows:", sum(nsf_emails$was_cut), "\n")
```